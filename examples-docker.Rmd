---
title: "Cloudera Quickstart Single Node"
output:
  html_document:
    toc: yes
    toc_float:
      collapsed: no
---
## Introdution 

The plan is to leverage the [Cloudera Quickstart Docker container](https://www.cloudera.com/documentation/enterprise/5-6-x/topics/quickstart_docker_container.html) to quickly create a YARN managed environment you can test sparklyr on.  This instructions focus on deploying this server in on [Amazon's EC2 hosted server](https://aws.amazon.com/ec2/).  If you are already a Docker user, and prefer to install it on your local machine, please feel free to adapt the instructions to suit.  

## EC2 Instance

Here are the details of the EC2 instance we used:

- **Type:** t2.large
- **OS:** Ubuntu 16 (Xenial)
- **Disk space:** At least 40GB (since you may be creating copies of the image)
- **Security group:** Consider opening the ports listed in the *Installing Cloudera* section

## Installation

### Installing docker

These following commands are taken from the [Install Docker on Ubuntu](https://docs.docker.com/engine/installation/linux/ubuntulinux/) instructions.  We've selected the steps that match to the Ubuntu OS selected in the *EC2 Instance* section.

```{bash, eval=FALSE}
sudo apt-get update
sudo apt-get install apt-transport-https ca-certificates
sudo apt-key adv --keyserver hkp://p80.pool.sks-keyservers.net:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D
echo "deb https://apt.dockerproject.org/repo ubuntu-xenial main" | sudo tee /etc/apt/sources.list.d/docker.list
sudo apt-get update
sudo apt-get install linux-image-extra-$(uname -r) linux-image-extra-virtual
sudo apt-get install docker-engine
sudo service docker start
```

Test docker by running the 'hello world' image

```{bash, eval=FALSE}
sudo docker run hello-world
```

### Installing Cloudera

Pull the latest Cloudera Quickstart docker image.  The file is around 4GBs.

```{bash, eval=FALSE}
sudo docker pull cloudera/quickstart:latest
```

This is where we divert from the 'run' command in the original instructions.  We will map the container's ports to predictable ports in the EC2 instance, this so that they can be access via the Web.  Here is a list of the port and the services the map:

- Hue: 8888
- Spark History Server: 18088
- RStudio Server: 8787
- Cloudera Manager (not enabled by default): 7180
- sparklyr web UI: 8088
- Shiny: 3838


```{bash, eval=FALSE}
sudo docker run --hostname=quickstart.cloudera --privileged=true -t -i -p 8888:8888 -p 18088:18088 -p 8787:8787 -p 7180:7180 -p 8088:8088 -p 3838:3838 cloudera/quickstart /usr/bin/docker-quickstart
```

The command will initiate the cluster.  After it's completed, the terminal session your are in will be inside the docker container's session. The prompt will now read: "[root@quickstart /]# "

### Installing RStudio

Now we will install the following:

- wget - To download files
- Base R
- RStudio Server
- Package dependencies

```{bash, eval=FALSE}
yum install wget
sudo yum install R
wget https://s3.amazonaws.com/rstudio-dailybuilds/rstudio-server-rhel-1.0.118-x86_64.rpm
sudo yum install --nogpgcheck rstudio-server-rhel-1.0.118-x86_64.rpm
yum install openssl-devel; yum install libcurl-devel; yum install libxml2-devel
```

Setup default user

```{bash, eval=FALSE}
sudo adduser [made-up-user]
sudo passwd [made-up-password]
```

### Installing sparklyr

- Navigate to your RStudio Server, port 8787

- Sign on with the default user setup in the previous section

- Install sparklyr and tidyverse.  Because today the package is being maintained on a regular basis, we will install the dev version of sparklyr.  Feel free to install the CRAN version if preferred.

```{r, eval=FALSE}
install.packages("devtools")
devtools::install_github("rstudio/sparklyr")
install.packages("tidyverse")
```

Here's the code we'll use to connect to the local Cloudera Quickstart single-node cluster.  The main part of the code is to setup the Spark Home to a path inside the Quickstart installation.

```{r, eval=FALSE}
library(sparklyr)
library(dplyr)
Sys.setenv(SPARK_HOME = '/usr/lib/spark')
sc <- spark_connect(master = "yarn-client", version="1.6.0")
```

## Management

### Shutting down

If you wish to **stop** the EC2 instance without loosing your work, please make sure to stop all the services inside the container first.

The services that we stop are based on the [Stopping CDH Services Using the Command Line](https://www.cloudera.com/documentation/enterprise/5-5-x/topics/cdh_ig_services_stop.html) article.

- Copy and paste this long concatenated command inside the container:
```{bash, eval=FALSE}
sudo service hue stop; sudo service impala-server stop; sudo service impala-catalog stop; sudo service impala-state-store stop; sudo service oozie stop; sudo service hiveserver2 stop; sudo service hive-webhcat-server stop; sudo service hive-metastore stop; sudo service flume-ng-agent stop;sudo service sqoop-metastore stop; sudo service sqoop2-server stop; sudo service hbase-solr-indexer stop;sudo service spark-worker stop; sudo service spark-history-server stop; sudo service spark-master stop; sudo service sentry-store stop; sudo service solr-server stop; sudo service hbase-thrift stop; sudo service hbase-rest stop; sudo service hbase-regionserver stop; sudo service hbase-master stop; sudo service hadoop-0.20-mapreduce-jobtrackerha stop ; sudo service hadoop-0.20-mapreduce-jobtracker stop ; sudo service hadoop-0.20-mapreduce-tasktracker stop; sudo service hadoop-mapreduce-historyserver stop;  sudo service hadoop-yarn-resourcemanager stop; sudo service hadoop-yarn-nodemanager stop; sudo service hadoop-httpfs stop; sudo service hadoop-hdfs-nfs3 stop; sudo service hadoop-hdfs-secondarynamenode stop; sudo service hadoop-hdfs-namenode stop; sudo service hadoop-hdfs-journalnode stop; sudo service hadoop-hdfs-datanode stop ; sudo service hadoop-kms-server stop; sudo service zookeeper-server stop;
```
- Run the **exit** command, this will take you back to the EC2 prompts
- In the EC2 terminal, type **sudo docker ps** to confirm the container is stopped
- Stop the EC2 instance in AWS

### Starting up 

- Logon the server 
- We will try to get the instance id by attempting to delete the image.  This has been the best way I found to obtain the id of a container that is stopped.
```{bash, eval=FALSE}
sudo docker rmi cloudera/quickstart
```
- In the warning message, note the container ID that it says depends on the image
- Start the container
```{bash, eval=FALSE}
sudo docker start [container id]
```
- This command will attach your terminal session to the container
```{bash, eval=FALSE}
sudo docker attach [container id]
```
- Inside the docker container, start the rstudio-server 
```{}
[root@quickstart /]# sudo service rstudio-server start
```
 