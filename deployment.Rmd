---
title: "Deploying Spark and sparklyr"
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(eval = FALSE)
```

## Deployment Modes

There are two well supported deployment modes for **sparklyr**: developing locally (typically on the desktop with smaller/sampled datasets) and working directly within a Spark cluster via RStudio Server.

### Local Deployment

Local mode is an excellent way to learn and experiment with Spark. Local mode also provides a convenient development environment for analyses, reports, and applications that you plan to eventually deploy to a multi-node Spark cluster.

To work in local mode you should first install a version of Spark for local use. You can do this using the [spark_install](reference/sparklyr/latest/spark_install.htm) function, for example:

```{r}
spark_install(version = "1.6.1", hadoop_version = "2.6")
```

To connect to the local Spark instance you pass "local" as the value of the Spark master node to [spark_connect](reference/sparklyr/latest/spark_connect.htm):

```{r}
sc <- spark_connect(master = "local")
```

For the local development scenario, see the [Configuration] section below for details on how to have the same code work seamlessly in both development and production environments.

### Cluster Deployment

To use sparklyr within a Spark cluster you should run [RStudio Server](https://www.rstudio.com/products/rstudio/) either directly on one of the cluster nodes or on machine close to the cluster that has a Spark configuration identical to that of the cluster nodes.

In cluster mode you don't use a version of Spark installed via `spark_install`, rather, you use the version of Spark already deployed on the cluster node. This version is located via the `SPARK_HOME` environment variable, so you should be sure that this variable is correctly defined on your server before atteping a connection.

To connect, pass the address of the master node to `spark_connect`, for example:

```{r}
sc <- spark_connect(master = "spark://local:7077")
```

If you are running on EC2 using the Spark [EC2 deployment scripts](http://spark.apache.org/docs/latest/ec2-scripts.html) then you can read the master from `/root/spark-ec2/cluster-url`, for example:

```{r}
master <- system('cat /root/spark-ec2/cluster-url', intern=TRUE)
sc <- spark_connect(master)
```

## Configuration 

This section describes the various options available for configuring both the behavior of the **sparklyr** package as well as the underlying Spark cluster. Creating multiple configuration profiles (e.g. development, test, production) is also covered.

### Config Files

By default the sparklyr package reads it's configuration from a file named `config.yml` located in the current working directory (or in parent directories if not located in the working directory). This file is not required and only need be provided for overriding default behavior. The `config.yml` file is in turn processed using the [config](https://github.com/rstudio/config) package, which enables support for multiple named configuration profiles.

### Package Options

There are a number of options available to configure the behavior of the sparklyr package:

| Option | Description  |
|----------------------------|---------------------------------------------|
| `sparklyr.defaultPackages`| Spark packages to automatically include within session (defaults to "com.databricks:spark-csv_2.11:1.3.0" and "com.amazonaws:aws-java-sdk-pom:1.10.34") |
| `sparklyr.cores.local` | Number of cores to use when running in local mode (defaults to `parallel::detectCores`) |
| `sparklyr.shell.*` | Command line parameters to pass to `spark-shell` (see the [Spark documentation](https://spark.apache.org/docs/latest/submitting-applications.html) for details on supported options) |

For example, this configuration file sets the number of local cores to 4 and the amount of memory allocated for the Spark driver to 2G:

```yaml
default:
  sparklyr.cores.local: 4
  sparklyr.shell.driver-memory: 4GB
```

Note that the use of `default` will be explained below in [Multiple Profiles].

### Spark Options

You can also use `config.yml` to specify arbitrary Spark configuration properties:

| Option | Description  |
|----------------------------|---------------------------------------------|

| `spark.*` Arbitrary configuration properties (applied by creating a `SparkConf` containing the specified properties). See the [Spark Configuration](http://spark.apache.org/docs/latest/configuration.html) for documentation on available properties.
| `spark.sql.*`| Arbitrary configuration properties for Spark SQL (applied using SET). See the Spark [SQL Programming Guide](http://spark.apache.org/docs/latest/sql-programming-guide.html) for documentation on available properties. |

For example, this configuration file set a custom scratch directory for Spark and specifies 100 as the number of partitions to use when shuffling data for joins or aggregations:

```yaml
default:
  spark.local.dir: /tmp/spark-scratch
  spark.sql.shuffle.partitions: 100
```

### User Options

You can also include arbitrary custom user options within the `config.yml` file. These can be named anything you like so long as they *do not* use either `spark` or `sparklyr` as a prefix. For example, this configuration file defines `dataset` and `sample-size` options:

```yaml
default:
  dataset: "observations.parquet"
  sample-size: 10000
```

### Multiple Profiles

The [config](https://github.com/rstudio/config) package enables the definition of multiple named configuration profiles for different environments (e.g. default, test, production). All environments automatically inherit from the `default` environment and can optionally also inherit from each other.

For example, you might want to use a distinct datasets for development and testing or might want to use custom Spark configuration properties that are only applied when running on a production cluster. Here's how that would expressed in `config.yml`:

```yaml
default:
  dataset: "observations-dev.parquet"
  sample-size: 10000
  
production:
  spark.memory.fraction: 0.9
  spark.rdd.compress: true
  dataset: "observations.parquet"
  sample-size: null
```

You can also use this feature to specify distinct Spark master nodes for different environments, for example:

```yaml
default:
  spark.master: "local"
  
production:
  spark.master: "spark://local:7077"
```

With this configuration, you can omit the `master` argument entirely from the call to `spark_connect`:

```{r}
sc <- spark_connect()
```

Note that the currently active configuration is determined via the value of `R_CONFIG_ACTIVE` environment variable. See the [config package documentation](https://github.com/rstudio/config) for additional details.

## RStudio Server

RStudio Server provides a web-based IDE interface to a remote R session, making it ideal for use as a front-end to a Spark cluster. This section covers some additional configuration options that are useful for RStudio Server.

### Connection Options

The RStudio IDE provides a **New Connection** dialog to assist in conneting with both local instances of Spark and Spark clusters:

<img src="images/connect-to-spark.png" width=486 height=302/>

You can configure what connection choices are presented using the `rstudio.spark.connections` option. By default, users are presented with possibility of both local and cluster connections, however, you can modify this behavior to present only one of these, or even a specific Spark master URL. Some commonly used combinations of connection choices include:

| Value | Description  |
|----------------------------|---------------------------------------------|
| `c("local", "cluster")` | Default. Present connections to both local and cluster Spark instances. |
| `"local"`| Present only connections to local Spark instances. |
| `"cluster"`| Present only connections to Spark clusters. |
| `"spark://local:7077"`| Present only a connection to a specific Spark cluster. |
| `c("spark://local:7077", "cluster")`| Present a connection to a specific Spark cluster and other clusters. |


### Spark Installations

If you are running within local mode (as opposed to cluster mode) you may want to provide pre-installed Spark version(s) to be shared by all users of the server. You can do this by installing Spark versions within a shared directory (e.g. `/opt/spark`) then designating it as the Spark installation directory. 

For example, after installing one or more versions of Spark to `/opt/spark` you would add the following to [Rprofile.site](https://stat.ethz.ch/R-manual/R-devel/library/base/html/Startup.html):

```{r}
options(spark.install.dir = "/opt/spark")
```

If this directory is read-only for ordinary users then RStudio will not offer installation of additional versions, which will help guide users to a version that is known to be compatible with versions of Spark deployed on clusters in the same organization.


